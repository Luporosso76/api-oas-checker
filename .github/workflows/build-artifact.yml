name: Build OAS Checker IT (Full Ruleset)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout api-oas-checker
        uses: actions/checkout@v4

      - name: Checkout rules repository
        uses: actions/checkout@v4
        with:
          repository: italia/api-oas-checker-rules
          path: api-oas-checker-rules

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build rulesets (including Full)
        shell: bash
        run: |
          set -e
          cd api-oas-checker-rules
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          mkdir -p rulesets rulesets/functions

          build_ruleset () {
            local folders="$1"
            local name="$2"
            local outfile="$3"
            local cfg="${4:-}"
            export RULES_FOLDERS="$folders"
            export RULESET_NAME="$name"
            export RULESET_VERSION="1.0"
            export RULESET_FILE_NAME="$outfile"
            export TEMPLATE_FILE="rules/rules-template.yml.template"
            if [ -n "$cfg" ]; then
              export CONFIG_FILE="$cfg"
            else
              unset CONFIG_FILE || true
            fi
            python builder.py
          }

          build_ruleset "rules/" "Italian Guidelines Full" "rulesets/spectral.yml"
          build_ruleset "rules/" "Best Practices Only" "rulesets/spectral-generic.yml" "override/spectral-generic-override.yml"
          build_ruleset "security/" "Extra Security Checks" "rulesets/spectral-security.yml"
          build_ruleset "rules/,security/" "Italian Guidelines Full + Extra Security Checks" "rulesets/spectral-full.yml"
          build_ruleset "rules/" "Italian Guidelines" "rulesets/spectral-modi.yml" "override/spectral-modi-override.yml"

          # funzioni custom per spectral
          cp -f security/functions/* rulesets/functions/ || true

      - name: Copy rulesets into checker repo
        run: |
          set -e
          rm -rf rulesets
          mkdir -p rulesets
          cp -R api-oas-checker-rules/rulesets/* rulesets/

      - name: Localize UI text to Italian + default Full ruleset
        run: |
          python - <<'PY'
          from pathlib import Path

          # 1) Default ruleset => Italian Guidelines Full
          wp = Path("webpack.config.js")
          s = wp.read_text(encoding="utf-8")
          s = s.replace("fileMap[filePath].rulesetName === 'Italian Guidelines'",
                        "fileMap[filePath].rulesetName === 'Italian Guidelines Full'")
          wp.write_text(s, encoding="utf-8")

          # 2) Stringhe UI principali (sorgenti)
          replacements = {
            "Step 1. Load the OpenAPI interface": "Step 1. Carica l'interfaccia OpenAPI",
            "Step 2. Choose a ruleset": "Step 2. Scegli il ruleset",
            "Step 3. Validation Results": "Step 3. Risultati validazione",
            "Step 4. Run Validation": "Step 4. Avvia validazione",
            "Validating...": "Validazione in corso...",
            "Check API": "Valida API",
            "Load OpenAPI ...": "Carica OpenAPI ...",
            "Load OpenAPI": "Carica OpenAPI",
            "Validation Results": "Risultati validazione",
            "Current Ruleset Bundle:": "Bundle ruleset corrente:",
            "No errors": "Nessun errore",
            "No warnings": "Nessun warning",
            "No hints": "Nessun suggerimento",
            "errors": "errori",
            "warnings": "warning",
            "hints": "suggerimenti"
          }

          for p in Path("src").rglob("*.js"):
            txt = p.read_text(encoding="utf-8")
            orig = txt
            for en, it in replacements.items():
              txt = txt.replace(en, it)
            if txt != orig:
              p.write_text(txt, encoding="utf-8")
          PY

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Enable corepack
        run: corepack enable

      - name: Install dependencies (retry-safe)
        shell: bash
        run: |
          set -e
          yarn --version
          yarn install --frozen-lockfile --network-timeout 600000 || (
            echo "Retry after cache clean..."
            yarn cache clean
            yarn install --frozen-lockfile --network-timeout 600000
          )

      - name: Build dist (production)
        run: NODE_ENV=production yarn build-js

      # ENFORCE ITALIANO anche sui file minificati finali (dist)
      - name: Enforce Italian UI in dist (post-build)
        run: |
          python - <<'PY'
          from pathlib import Path

          replacements = {
            "Step 1. Load the OpenAPI interface": "Step 1. Carica l'interfaccia OpenAPI",
            "Step 2. Choose a ruleset": "Step 2. Scegli il ruleset",
            "Step 3. Validation Results": "Step 3. Risultati validazione",
            "Step 4. Run Validation": "Step 4. Avvia validazione",
            "Validating...": "Validazione in corso...",
            "Check API": "Valida API",
            "Load OpenAPI ...": "Carica OpenAPI ...",
            "Load OpenAPI": "Carica OpenAPI",
            "Validation Results": "Risultati validazione",
            "Current Ruleset Bundle:": "Bundle ruleset corrente:",
            "No errors": "Nessun errore",
            "No warnings": "Nessun warning",
            "No hints": "Nessun suggerimento",
            "errors": "errori",
            "warnings": "warning",
            "hints": "suggerimenti",
            "Error loading document from URL:": "Errore nel caricamento del documento da URL:",
            "Validation error:": "Errore di validazione:",
            "An unknown error occurred in the validation worker.": "Si Ã¨ verificato un errore sconosciuto nel worker di validazione."
          }

          files = list(Path("dist").rglob("*.js")) + list(Path("dist").rglob("*.html")) + list(Path("dist").rglob("*.css"))
          changed = 0
          total = 0
          for f in files:
            txt = f.read_text(encoding="utf-8", errors="ignore")
            orig = txt
            for en, it in replacements.items():
              c = txt.count(en)
              if c:
                txt = txt.replace(en, it)
                total += c
            if txt != orig:
              f.write_text(txt, encoding="utf-8")
              changed += 1

          print(f"[IT] files changed={changed}, replacements={total}")
          PY

      - name: Verify Italian labels (sanity check)
        shell: bash
        run: |
          set -e
          if grep -R "Step 1. Load the OpenAPI interface" dist; then echo "EN label found"; exit 1; fi
          if grep -R "Check API" dist; then echo "EN label found"; exit 1; fi
          if grep -R "Load OpenAPI" dist; then echo "EN label found"; exit 1; fi

      - name: Zip dist
        run: |
          cd dist
          zip -r ../api-oas-checker-dist-it.zip .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: api-oas-checker-dist-it
          path: api-oas-checker-dist-it.zip
